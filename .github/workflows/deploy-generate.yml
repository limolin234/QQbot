name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (如: v1.0.0.0)'
        required: true
        default: 'v1.0.0.0'
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION=${{ github.ref_name }}
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "版本号: $VERSION"
          
      # [新增步骤]：大胆创新，自动同步最新配置；谨慎落实，严格校验文件存在性
      - name: Update example files in deploy directory
        run: |
          echo "--- 开始同步最新的配置文件到 deploy 目录 ---"
          
          # 确保目标子目录存在
          mkdir -p deploy/workflows
          
          # 1. 同步 .env.example
          if [ -f ".env.example" ]; then
            cp -f .env.example deploy/.env.example
            echo "✅ 已更新 deploy/.env.example"
          fi
          
          # 2. 同步 config.yaml (主目录无example后缀，拷贝时自动重命名为example，防止泄露真实配置)
          if [ -f "config.yaml" ]; then
            cp -f config.yaml deploy/config.yaml.example
            echo "✅ 已更新 deploy/config.yaml.example"
          fi
          
          # 3. 同步 workflows/agent_config.yaml.example
          if [ -f "workflows/agent_config.yaml.example" ]; then
            cp -f workflows/agent_config.yaml.example deploy/workflows/agent_config.yaml.example
            echo "✅ 已更新 deploy/workflows/agent_config.yaml.example"
          fi
      
      - name: Create deploy package
        run: tar -czf qqbot.tar.gz deploy/
          
      - name: Generate download script
        run: |
          cat > qqbot_download.sh << 'EOF'
          #!/bin/bash
          URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/qqbot.tar.gz"
          INSTALL_DIR="qqbot_deploy"
          TEMP_FILE="deploy.tar.gz"
          set -euo pipefail
          echo "--- 开始部署 QQbot ---"
          echo "[1/4] 检查依赖环境..."
          for cmd in curl tar; do
              if ! command -v $cmd &> /dev/null; then
                  echo "错误: 未安装 $cmd"
                  exit 1
              fi
          done
          echo "[2/4] 正在下载..."
          curl -fsSL "$URL" -o "$TEMP_FILE"
          echo "[3/4] 正在解压..."
          mkdir -p "$INSTALL_DIR"
          tar -xzf "$TEMP_FILE" -C "$INSTALL_DIR" --strip-components=1
          echo "[4/4] 清理临时文件..."
          rm "$TEMP_FILE"
          echo "✅ 部署成功！"
          EOF
          chmod +x qqbot_download.sh
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          body: 给一键脚本用的压缩包，手动下载下来然后配置也是可以的，内含readme.md
          files: |
            qqbot.tar.gz
            qqbot_download.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
