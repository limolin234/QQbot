# QQ Bot with LangGraph Multi-Agent System

åŸºäº NapCat å’Œ LangGraph çš„å¤š Agent QQ ç¾¤èŠæœºå™¨äººï¼Œæ”¯æŒå¯¹è¯è®°å¿†ã€æ™ºèƒ½å“åº”å’Œé€šçŸ¥æ‘˜è¦ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **å¤š Agent æ¶æ„**ï¼šæ”¯æŒå¤šä¸ª Agent å¹¶è¡Œå¤„ç†æ¶ˆæ¯
- âœ… **å®æ—¶æ¶ˆæ¯å¤„ç†**ï¼šåŸºäº WebSocket å®æ—¶æ¥æ”¶å’Œå“åº”ç¾¤æ¶ˆæ¯
- âœ… **æ™ºèƒ½è·¯ç”±**ï¼šæ ¹æ®è§¦å‘æ¡ä»¶è‡ªåŠ¨è·¯ç”±åˆ°åˆé€‚çš„ Agent
- âœ… **å¯¹è¯è®°å¿†**ï¼šä½¿ç”¨ LangGraph çš„ checkpointing æœºåˆ¶ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„å¯¹è¯ä¸Šä¸‹æ–‡
- âœ… **CLI æ§åˆ¶é¢æ¿**ï¼šå®æ—¶æ˜¾ç¤º Agent è¿è¡ŒçŠ¶æ€ã€ç»Ÿè®¡ä¿¡æ¯
- âœ… **å®Œæ•´æ—¥å¿—**ï¼šè¯¦ç»†çš„è¿è¡Œæ—¥å¿—å’Œæ¶ˆæ¯å¤„ç†æ—¥å¿—ï¼Œæ ‡æ³¨ Agent èº«ä»½
- âœ… **ç§èŠé€šçŸ¥**ï¼šæ”¯æŒè¯†åˆ«é‡è¦é€šçŸ¥å¹¶ç§èŠå‘é€æ‘˜è¦

### Agent ç±»å‹
1. **èŠå¤©åŠ©æ‰‹ (SimpleChatAgent)**
   - å‹å¥½çš„ç¾¤èŠåŠ©æ‰‹
   - æ”¯æŒ @ å”¤é†’å’Œå…³é”®è¯å”¤é†’
   - å¯¹è¯è®°å¿†åŠŸèƒ½
   - æ··åˆè§¦å‘æ¨¡å¼ï¼ˆå…³é”®è¯ + @ æ£€æµ‹ï¼‰

2. **é€šçŸ¥æ‘˜è¦åŠ©æ‰‹ (NotificationAgent)** â­ æ–°å¢
   - ä½¿ç”¨ LLM æ™ºèƒ½è¯†åˆ«é‡è¦é€šçŸ¥ï¼ˆä½œä¸šã€è€ƒè¯•ã€æ´»åŠ¨ç­‰ï¼‰
   - è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦
   - ç§èŠå‘é€ç»™æŒ‡å®šç”¨æˆ·
   - æ”¯æŒå…¨éƒ¨ç›‘å¬æ¨¡å¼ï¼ˆé€‚åˆä½é¢‘é€šçŸ¥ç¾¤ï¼‰
   - ä½¿ç”¨è‡ªå®šä¹‰ TypedDict State ç¡®ä¿çŠ¶æ€æ­£ç¡®ä¼ é€’

### å®‰å…¨ä¿æŠ¤
- âœ… æ¶ˆæ¯é•¿åº¦é™åˆ¶ï¼ˆ500å­—ç¬¦ï¼‰
- âœ… é¢‘ç‡é™åˆ¶ï¼ˆ10æ¡/åˆ†é’Ÿï¼‰
- âœ… è¿è§„è®¡æ•°å’Œæš‚åœæœºåˆ¶

## ğŸ¯ å®é™…è¿è¡Œæ•ˆæœ

### CLI æ§åˆ¶é¢æ¿
å¯åŠ¨åä¼šæ˜¾ç¤ºå®æ—¶æ§åˆ¶é¢æ¿ï¼Œç›‘æ§æ‰€æœ‰ Agent çš„è¿è¡ŒçŠ¶æ€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ğŸ® QQ Bot å¤š Agent æ§åˆ¶é¢æ¿                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¤– Agent è¿è¡ŒçŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent ID     â”‚ åç§°     â”‚ çŠ¶æ€   â”‚ è¿è¡Œæ¬¡æ•°â”‚ æ€»æ—¶é•¿ â”‚ å¹³å‡æ—¶é•¿â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ simple_chat  â”‚ èŠå¤©åŠ©æ‰‹ â”‚ ğŸŸ¢ è¿è¡Œä¸­â”‚   15   â”‚ 23.5s  â”‚ 1.57s  â”‚
â”‚ notification â”‚ é€šçŸ¥æ‘˜è¦ â”‚ ğŸŸ¢ è¿è¡Œä¸­â”‚    3   â”‚  4.2s  â”‚ 1.40s  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆæ¯å¤„ç†æ—¥å¿—
```
ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ | ç¾¤:1075786046 | ç”¨æˆ·:æµ·å¿ƒ(3291053545) | å†…å®¹:ã€æ ¡"è£èª‰å–œæŠ¥"å¯„é€ä¿¡æ¯ç»Ÿè®¡ã€‘...
ğŸ¤– [é€šçŸ¥æ‘˜è¦åŠ©æ‰‹] å¤„ç†ä¸­ | ç¾¤:1075786046 | ç”¨æˆ·:3291053545
âœ… é€šçŸ¥åˆ†ææˆåŠŸ: is_important=True, category=è£èª‰å¥–é¡¹ç›¸å…³é€šçŸ¥
ğŸ”” æ£€æµ‹åˆ°é‡è¦é€šçŸ¥ï¼Œå‡†å¤‡å‘é€ç§èŠ
ğŸ“¤ [é€šçŸ¥æ‘˜è¦åŠ©æ‰‹] ç§èŠæ¶ˆæ¯å·²å‘é€ | ç”¨æˆ·:3291053545
```

### ç§èŠé€šçŸ¥æ•ˆæœ
å½“æ£€æµ‹åˆ°é‡è¦é€šçŸ¥æ—¶ï¼Œä¼šè‡ªåŠ¨å‘é€ç§èŠæ‘˜è¦ï¼š

```
ğŸ“¢ é‡è¦é€šçŸ¥æé†’

ã€è£èª‰å¥–é¡¹ç›¸å…³é€šçŸ¥ã€‘
ç¾¤å·ï¼š1075786046
å‘é€è€…ï¼šè€å¸ˆ

ğŸ“ æ‘˜è¦ï¼š
å­¦æ ¡å¯„é€è£èª‰å–œæŠ¥ï¼Œè·å¥–åŒå­¦å¯è‡ªæ„¿å¡«å†™æ”¶ä»¶ä¿¡æ¯ï¼Œæˆªæ­¢1æœˆ29æ—¥17:00

âš ï¸ å…³é”®ä¿¡æ¯ï¼šæˆªæ­¢æ—¶é—´1æœˆ29æ—¥17:00

---
åŸå§‹æ¶ˆæ¯ï¼š
ã€æ ¡"è£èª‰å–œæŠ¥"å¯„é€ä¿¡æ¯ç»Ÿè®¡ã€‘@å…¨ä½“æˆå‘˜
æ ¹æ®å­¦æ ¡å®‰æ’ï¼Œä»Šå¹´è·å¾—äº†"ä¸‰å¥½å­¦ç”Ÿæ ‡å…µ""å­¦æœ¯æ–°æ˜Ÿ"...
```

```
NapCat WebSocket
    â†“
æ¶ˆæ¯æ¥æ”¶å¾ªç¯ (main.py)
    â†“
AgentManager (æ¶ˆæ¯è·¯ç”±å’Œé˜Ÿåˆ—ç®¡ç†)
    â†“
å¤šä¸ª Agent å¹¶è¡Œå¤„ç†
    â”œâ”€ SimpleChatAgent (èŠå¤©åŠ©æ‰‹)
    â””â”€ NotificationAgent (é€šçŸ¥æ‘˜è¦)
    â†“
å‘é€å“åº” (ç¾¤æ¶ˆæ¯/ç§èŠ)
```

### å…³é”®æŠ€æœ¯å®ç°

#### 1. NotificationAgent çš„ LangGraph å®ç°

ä½¿ç”¨è‡ªå®šä¹‰ `TypedDict` State ç¡®ä¿çŠ¶æ€æ­£ç¡®ä¼ é€’ï¼š

```python
# å®šä¹‰è‡ªå®šä¹‰ State
class NotificationState(TypedDict):
    message: str          # åŸå§‹æ¶ˆæ¯
    is_important: bool    # æ˜¯å¦é‡è¦
    category: str         # ç±»åˆ«
    summary: str          # æ‘˜è¦
    key_info: str         # å…³é”®ä¿¡æ¯

# æ„å»º Graph
graph_builder = StateGraph(NotificationState)
graph_builder.add_node("analyze", self._analyze_node)
graph_builder.add_edge(START, "analyze")
graph_builder.add_edge("analyze", END)
graph = graph_builder.compile()

# è°ƒç”¨ Graph
result = self.graph.invoke({
    "message": message_text,
    "is_important": False,
    "category": "",
    "summary": "",
    "key_info": ""
})

# è·å–ç»“æœ
if result.get("is_important"):
    # å‘é€ç§èŠé€šçŸ¥
    await self.napcat_client.send_private_msg(target_user, summary)
```

#### 2. LLM ç»“æ„åŒ–è¾“å‡º

ä½¿ç”¨ JSON mode ç¡®ä¿ LLM è¿”å›æ­£ç¡®æ ¼å¼ï¼š

```python
# åˆå§‹åŒ– LLM with JSON mode
self.llm = ChatOpenAI(
    model="deepseek-v3",
    temperature=0.3,
    model_kwargs={"response_format": {"type": "json_object"}}
)

# LLM è¿”å› JSON
response = self.llm.invoke([
    SystemMessage(content="ä½ å¿…é¡»è¿”å› JSON æ ¼å¼..."),
    HumanMessage(content=f"è¯·åˆ†æï¼š{message}")
])

# è§£æ JSON
result = json.loads(response.content)
```

#### 3. å¹¶è¡Œå¤„ç†æœºåˆ¶

æ¯ä¸ª Agent ç‹¬ç«‹é˜Ÿåˆ—ï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†ï¼š

```python
# AgentManager ä¸ºæ¯ä¸ª Agent åˆ›å»ºé˜Ÿåˆ—å’Œ worker
self.queues[agent_id] = asyncio.Queue()
self.workers[agent_id] = asyncio.create_task(self._agent_worker(agent_id))

# æ¶ˆæ¯è·¯ç”±åˆ°å¤šä¸ª Agent
for agent_id in triggered_agents:
    await self.queues[agent_id].put(message_data)
```

### å…³é”®ç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| **AgentManager** | `core/agent_manager.py` | Agent æ³¨å†Œã€æ¶ˆæ¯è·¯ç”±ã€é˜Ÿåˆ—å¤„ç† |
| **SimpleChatAgent** | `agents/simple_chat_agent.py` | èŠå¤©å¯¹è¯ Agent |
| **NotificationAgent** | `agents/notification_agent.py` | é€šçŸ¥è¯†åˆ«å’Œæ‘˜è¦ Agent |
| **NapCatClient** | `core/napcat_client.py` | WebSocket å®¢æˆ·ç«¯ï¼Œæ”¯æŒç¾¤æ¶ˆæ¯å’Œç§èŠ |
| **CLIPanel** | `utils/cli_panel.py` | å®æ—¶æ§åˆ¶é¢æ¿ |
| **é…ç½®æ–‡ä»¶** | `config/agents_config.py` | Agent é…ç½® |

## ğŸ“‹ ç¯å¢ƒè¦æ±‚

- Python 3.8+
- NapCatï¼ˆå·²å®‰è£…å¹¶è¿è¡Œï¼‰
- OpenAI Compatible APIï¼ˆå¦‚ Yunwu AIã€DeepSeek ç­‰ï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

ä¸»è¦ä¾èµ–ï¼š
- `langchain-openai` - LangChain OpenAI é›†æˆ
- `langgraph` - LangGraph æ¡†æ¶
- `loguru` - æ—¥å¿—ç³»ç»Ÿ
- `websockets` - WebSocket å®¢æˆ·ç«¯
- `python-dotenv` - ç¯å¢ƒå˜é‡ç®¡ç†
- `rich` - CLI é¢æ¿

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å†™ï¼š

```env
YUNWU_API_KEY=sk-xxx...
API_BASE_URL=https://yunwu.ai/v1
```

**æ³¨æ„**ï¼šä¸éœ€è¦é…ç½® NapCat ç›¸å…³çš„ Tokenï¼Œæœ¬åœ°è¿æ¥æ— éœ€è®¤è¯ã€‚

### 3. é…ç½® NapCat WebSocket æœåŠ¡

#### æ­¥éª¤ï¼š
1. å¯åŠ¨ NapCat
2. è®¿é—® WebUIï¼š`http://127.0.0.1:6099/webui/`
3. ç™»å½•åè¿›å…¥"ç½‘ç»œé…ç½®"
4. æ·»åŠ  **WebSocket æœåŠ¡ç«¯**é…ç½®ï¼š

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| å¯ç”¨ | âœ… å¼€å¯ | å¿…é¡»å¼€å¯ |
| Host | `127.0.0.1` | æœ¬åœ°ç›‘å¬ |
| Port | `3001` | é»˜è®¤ç«¯å£ï¼ˆä¸ä»£ç é…ç½®ä¸€è‡´ï¼‰ |
| ä¸ŠæŠ¥è‡ªèº«æ¶ˆæ¯ | âŒ å…³é—­ | é¿å… bot å“åº”è‡ªå·±çš„æ¶ˆæ¯ |
| å¼ºåˆ¶æ¨é€äº‹ä»¶ | âœ… å¼€å¯ | ç¡®ä¿äº‹ä»¶æ­£å¸¸æ¨é€ |
| Token | ç•™ç©º | æœ¬åœ°è¿æ¥ä¸éœ€è¦ Token |
| å¿ƒè·³é—´éš” | `30000` | é»˜è®¤å€¼å³å¯ |
| å¼€å¯ Debug | âœ… å¼€å¯ | æµ‹è¯•é˜¶æ®µå»ºè®®å¼€å¯ |

5. ä¿å­˜é…ç½®å¹¶é‡å¯ NapCat

### 4. é…ç½® Agent

ç¼–è¾‘ `config/agents_config.py`ï¼š

#### èŠå¤©åŠ©æ‰‹é…ç½®

```python
"simple_chat": {
    "enabled": True,
    "name": "èŠå¤©åŠ©æ‰‹",
    "class": "SimpleChatAgent",
    "config": {
        "model": "deepseek-v3",
        "monitored_groups": [1075786046],  # ä¿®æ”¹ä¸ºä½ çš„ç¾¤å·
        "trigger_mode": "hybrid",  # all/keywords/hybrid
        "wake_words": [r"å°åŠ©æ‰‹", r"bot", r"æœºå™¨äºº"],
        "require_at": False,
        "system_prompt": "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„ç¾¤åŠ©æ‰‹..."
    }
}
```

#### é€šçŸ¥æ‘˜è¦åŠ©æ‰‹é…ç½®

```python
"notification": {
    "enabled": True,
    "name": "é€šçŸ¥æ‘˜è¦åŠ©æ‰‹",
    "class": "NotificationAgent",
    "config": {
        "model": "deepseek-v3",
        "monitored_groups": [123456789],  # é€šçŸ¥ç¾¤å·
        "target_user": 987654321,  # æ¥æ”¶æ‘˜è¦çš„ QQ å·
        "trigger_mode": "all",  # å…¨éƒ¨ç›‘å¬
        "notification_prompt": "..."  # é€šçŸ¥è¯†åˆ«æç¤ºè¯
    }
}
```

#### è§¦å‘æ¨¡å¼è¯´æ˜

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| `all` | ç›‘å¬æ‰€æœ‰æ¶ˆæ¯ | ä½é¢‘é€šçŸ¥ç¾¤ |
| `keywords` | ä»…å…³é”®è¯è§¦å‘ | èŠ‚çœ API è°ƒç”¨ |
| `hybrid` | å…³é”®è¯ + LLM æ·±åº¦åˆ†æ | èŠå¤©ç¾¤ï¼ˆæ¨èï¼‰ |

### 5. è¿è¡Œ Bot

```bash
python main.py
```

å¯åŠ¨åä¼šçœ‹åˆ°ï¼š
- ğŸ¤– Agent åŠ è½½ä¿¡æ¯
- ğŸ“Š å®æ—¶ CLI æ§åˆ¶é¢æ¿
- ğŸ“¨ æ¶ˆæ¯å¤„ç†æ—¥å¿—

## ğŸ“Š CLI æ§åˆ¶é¢æ¿

å¯åŠ¨åä¼šæ˜¾ç¤ºå®æ—¶æ§åˆ¶é¢æ¿ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ğŸ® QQ Bot å¤š Agent æ§åˆ¶é¢æ¿                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¤– Agent è¿è¡ŒçŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent ID     â”‚ åç§°     â”‚ çŠ¶æ€   â”‚ è¿è¡Œæ¬¡æ•°â”‚ æ€»æ—¶é•¿ â”‚ å¹³å‡æ—¶é•¿â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ simple_chat  â”‚ èŠå¤©åŠ©æ‰‹ â”‚ ğŸŸ¢ è¿è¡Œä¸­â”‚   15   â”‚ 23.5s  â”‚ 1.57s  â”‚
â”‚ notification â”‚ é€šçŸ¥æ‘˜è¦ â”‚ ğŸŸ¢ è¿è¡Œä¸­â”‚    3   â”‚  4.2s  â”‚ 1.40s  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“‹ æ§åˆ¶å‘½ä»¤
â€¢ Ctrl+C - é€€å‡ºç¨‹åº
â€¢ é¢æ¿æ¯ 1 ç§’è‡ªåŠ¨åˆ·æ–°
```

### ç¦ç”¨ CLI é¢æ¿

å¦‚æœä¸éœ€è¦ CLI é¢æ¿ï¼Œåœ¨ `config/agents_config.py` ä¸­è®¾ç½®ï¼š

```python
CLI_PANEL_CONFIG = {
    "enabled": False,
}
```

## ğŸ“ æ—¥å¿—ç³»ç»Ÿ

### åŒæ—¥å¿—ç³»ç»Ÿ

1. **å…¨å±€æ—¥å¿—** (`logs/bot.log`)
   - ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
   - è¿æ¥ã€åˆå§‹åŒ–ã€é”™è¯¯ä¿¡æ¯

2. **æ¶ˆæ¯å¤„ç†æ—¥å¿—** (`logs/message_handler.log`)
   - Agent å¤„ç†çš„æ¶ˆæ¯æµç¨‹
   - æ ‡æ³¨ Agent èº«ä»½

### æ—¥å¿—ç¤ºä¾‹

```
2026-02-04 16:30:00 | [æ¶ˆæ¯å¤„ç†] | ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ | ç¾¤:1075786046 | ç”¨æˆ·:å¼ ä¸‰(123456) | å†…å®¹:å°åŠ©æ‰‹ä½ å¥½
2026-02-04 16:30:00 | [æ¶ˆæ¯å¤„ç†] | ğŸ¤– [èŠå¤©åŠ©æ‰‹] å¤„ç†ä¸­ | ç¾¤:1075786046 | ç”¨æˆ·:123456 | æ¶ˆæ¯:ä½ å¥½
2026-02-04 16:30:01 | [æ¶ˆæ¯å¤„ç†] | ğŸ’¬ [èŠå¤©åŠ©æ‰‹] å›å¤ | ç¾¤:1075786046 | ç”¨æˆ·:123456 | å›å¤:ä½ å¥½ï¼...
2026-02-04 16:30:01 | [æ¶ˆæ¯å¤„ç†] | âœ… [èŠå¤©åŠ©æ‰‹] æ¶ˆæ¯å·²å‘é€ | ç¾¤:1075786046

2026-02-04 16:31:00 | [æ¶ˆæ¯å¤„ç†] | ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ | ç¾¤:123456789 | ç”¨æˆ·:è€å¸ˆ(999999) | å†…å®¹:æ˜å¤©äº¤ä½œä¸š
2026-02-04 16:31:00 | [æ¶ˆæ¯å¤„ç†] | ğŸ¤– [é€šçŸ¥æ‘˜è¦åŠ©æ‰‹] å¤„ç†ä¸­ | ç¾¤:123456789 | ç”¨æˆ·:999999 | æ¶ˆæ¯:æ˜å¤©äº¤ä½œä¸š
2026-02-04 16:31:02 | [æ¶ˆæ¯å¤„ç†] | ğŸ“¤ [é€šçŸ¥æ‘˜è¦åŠ©æ‰‹] ç§èŠæ¶ˆæ¯å·²å‘é€ | ç”¨æˆ·:987654321
```

## ğŸ”§ æ‰©å±•å¼€å‘

### æ·»åŠ æ–° Agent

1. **åˆ›å»º Agent ç±»** (`agents/my_agent.py`)

```python
from langchain_openai import ChatOpenAI
from langgraph.graph import StateGraph, MessagesState, START, END
from langgraph.checkpoint.memory import MemorySaver

class MyAgent:
    def __init__(self, agent_id, config, api_key, base_url, napcat_client):
        self.agent_id = agent_id
        self.agent_name = config.get("name")
        self.napcat_client = napcat_client

        # åˆå§‹åŒ– LLM
        self.llm = ChatOpenAI(api_key=api_key, base_url=base_url)

        # æ„å»º LangGraph
        self.graph = self._build_graph()

        # ç»Ÿè®¡ä¿¡æ¯
        self.stats = {"total_processed": 0, "success": 0, "errors": 0}

    def _build_graph(self):
        graph_builder = StateGraph(MessagesState)
        graph_builder.add_node("process", self._process_node)
        graph_builder.add_edge(START, "process")
        graph_builder.add_edge("process", END)
        return graph_builder.compile()

    def _process_node(self, state):
        # å¤„ç†é€»è¾‘
        pass

    def should_trigger(self, message_data):
        # è§¦å‘æ¡ä»¶
        return True

    async def process_message(self, message_data):
        # å¤„ç†æ¶ˆæ¯
        pass

    def get_stats(self):
        return {**self.stats, "agent_id": self.agent_id}
```

2. **æ³¨å†Œ Agent** (`config/agents_config.py`)

```python
AGENTS_CONFIG = {
    "my_agent": {
        "enabled": True,
        "name": "æˆ‘çš„ Agent",
        "class": "MyAgent",
        "module": "agents.my_agent",
        "config": {
            "model": "deepseek-v3",
            # å…¶ä»–é…ç½®...
        }
    }
}
```

3. **åœ¨ main.py ä¸­åŠ è½½**

```python
from agents.my_agent import MyAgent

# åœ¨åŠ è½½ Agent çš„éƒ¨åˆ†æ·»åŠ 
elif agent_class_name == "MyAgent":
    agent = MyAgent(...)
```

## ğŸ› æ•…éšœæ’æŸ¥

### 1. æ— æ³•è¿æ¥åˆ° NapCat

**ç—‡çŠ¶**ï¼š`æ— æ³•è¿æ¥åˆ° NapCatï¼Œè¯·æ£€æŸ¥ NapCat æ˜¯å¦è¿è¡Œ`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤ NapCat æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ WebSocket æœåŠ¡ç«¯æ˜¯å¦å¯ç”¨ï¼ˆç«¯å£ 3001ï¼‰
- æŸ¥çœ‹ NapCat æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

### 2. Bot ä¸å“åº”æ¶ˆæ¯

**ç—‡çŠ¶**ï¼šå‘é€æ¶ˆæ¯å Bot æ²¡æœ‰å›å¤

**æ£€æŸ¥æ¸…å•**ï¼š
- âœ… ç¾¤å·æ˜¯å¦åœ¨ `monitored_groups` ä¸­
- âœ… æ˜¯å¦ @ äº† Bot æˆ–åŒ…å«å”¤é†’è¯
- âœ… æŸ¥çœ‹ `logs/message_handler.log` æ˜¯å¦æœ‰å¤„ç†è®°å½•
- âœ… æ£€æŸ¥ API Key æ˜¯å¦æœ‰æ•ˆ

### 3. Agent æœªè§¦å‘

**ç—‡çŠ¶**ï¼šæ¶ˆæ¯è¢«æ¥æ”¶ä½† Agent æ²¡æœ‰å¤„ç†

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ Agent çš„ `should_trigger()` é€»è¾‘
- æŸ¥çœ‹ `trigger_mode` é…ç½®
- ç¡®è®¤ `enabled` ä¸º `True`

### 4. ç§èŠæ¶ˆæ¯å‘é€å¤±è´¥

**ç—‡çŠ¶**ï¼šé€šçŸ¥æ‘˜è¦æ— æ³•å‘é€

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤ `target_user` é…ç½®æ­£ç¡®
- æ£€æŸ¥ Bot æ˜¯å¦ä¸ç›®æ ‡ç”¨æˆ·æ˜¯å¥½å‹
- æŸ¥çœ‹ NapCat æ—¥å¿—

## ğŸ“š é¡¹ç›®ç»“æ„

```
QQbot/
â”œâ”€â”€ agents/                    # Agent å®ç°
â”‚   â”œâ”€â”€ simple_chat_agent.py  # èŠå¤©åŠ©æ‰‹
â”‚   â””â”€â”€ notification_agent.py # é€šçŸ¥æ‘˜è¦åŠ©æ‰‹
â”œâ”€â”€ config/                    # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ bot_config.py         # Bot åŸºç¡€é…ç½®
â”‚   â”œâ”€â”€ napcat_config.py      # NapCat è¿æ¥é…ç½®
â”‚   â””â”€â”€ agents_config.py      # Agent é…ç½®
â”œâ”€â”€ core/                      # æ ¸å¿ƒç»„ä»¶
â”‚   â”œâ”€â”€ napcat_client.py      # NapCat WebSocket å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ agent_manager.py      # Agent ç®¡ç†å™¨
â”‚   â”œâ”€â”€ message_filter.py     # æ¶ˆæ¯è¿‡æ»¤å™¨ï¼ˆå·²å¼ƒç”¨ï¼‰
â”‚   â””â”€â”€ message_handler.py    # æ¶ˆæ¯å¤„ç†å™¨ï¼ˆå·²å¼ƒç”¨ï¼‰
â”œâ”€â”€ utils/                     # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ logger.py             # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ message_logger.py     # æ¶ˆæ¯æ—¥å¿—
â”‚   â”œâ”€â”€ security.py           # å®‰å…¨é™åˆ¶
â”‚   â””â”€â”€ cli_panel.py          # CLI æ§åˆ¶é¢æ¿
â”œâ”€â”€ logs/                      # æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ bot.log               # å…¨å±€æ—¥å¿—
â”‚   â””â”€â”€ message_handler.log   # æ¶ˆæ¯å¤„ç†æ—¥å¿—
â”œâ”€â”€ main.py                    # ä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ .env                       # ç¯å¢ƒå˜é‡ï¼ˆéœ€åˆ›å»ºï¼‰
â”œâ”€â”€ .env.example              # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ requirements.txt          # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ README.md                 # é¡¹ç›®è¯´æ˜
â””â”€â”€ CONFIG.md                 # é…ç½®è¯´æ˜
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ™ è‡´è°¢

- [NapCat](https://github.com/NapNeko/NapCatQQ) - QQ Bot åè®®å®ç°
- [LangGraph](https://github.com/langchain-ai/langgraph) - Agent å·¥ä½œæµæ¡†æ¶
- [LangChain](https://github.com/langchain-ai/langchain) - LLM åº”ç”¨æ¡†æ¶
- [Rich](https://github.com/Textualize/rich) - ç»ˆç«¯ç¾åŒ–åº“
